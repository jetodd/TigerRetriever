(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({"/Users/tim/projects/TigerRetriever/src/js/jsongenerator.js":[function(require,module,exports){
var JsonGenerator = function () {};
module.exports = JsonGenerator;

var mapHeight = 6;
var minLand = 4;
var maxGap = 3;
var tileWidth = 45;
var tileHeight = 45;
var mapWidth = 300;

JsonGenerator.prototype = {


    recreateInitialJson: function () {
        var layers = [];
        var tilesets = [];
        var background = new Array(mapWidth * mapHeight);
        background.fill(139);

        layers.push(this.makeLayer(background, mapHeight, "backgroundLayer", 1, "tilelayer", true, mapWidth, 0, 0));
        layers.push(this.makeLayer(this.makeMapBase(), mapHeight, "blockedLayer", 1, "tilelayer", true, mapWidth, 0, 0));

        tilesets.push(this.makeTileset(1, "..\/images\/tiles_spritesheet.png", 934, 790, 0, "tiles_spritesheet", 2,
            tileWidth, tileHeight));

        return this.generate(mapHeight, mapWidth, tileWidth, tileHeight, tilesets, layers);
    },
    makeTileset: function (firstgid, imageLocation, imageHeight, imageWidth, margin, name, spacing, tileHeight, tileWidth) {
        return {
            "firstgid": firstgid,
            "image": imageLocation,
            "imageheight": imageHeight,
            "imagewidth": imageWidth,
            "margin": margin,
            "name": name,
            "properties": {},
            "spacing": spacing,
            "tileheight": tileHeight,
            "tilewidth": tileWidth
        };
    },
    makeMapBase: function () {
        var utils = require('./utils');
        var gapCount = 0;
        var landCount = 5;
        var mapBase = new Array(mapWidth * mapHeight);
        mapBase.fill(0);

        var startIndex = (mapHeight - 1) * mapWidth;
        var maxIndex = mapWidth * mapHeight;

        mapBase.fill(1, startIndex, startIndex + 15);
        mapBase.fill(1, maxIndex - 15, maxIndex);

        // Generate array for map
        // 1 = land, 0 = gap
        for (i = startIndex + 15; i < maxIndex - 15; i++) {
            if (landCount < minLand && landCount > 0) {
                mapBase[i] = 1;
                landCount++;
                gapCount = 0;
            } else {
                if (utils.getRandomInt(0, 1) == 1) {
                    gapCount++;
                    mapBase[i] = 0;
                    landCount = 0;
                } else {
                    mapBase[i] = 1;
                    landCount++;
                    gapCount = 0;
                }
            }
        }
        return mapBase;
    },
    makeLayer: function (data, height, name, opacity, type, visible, width, x, y, objects) {
        layer = {
            "height": height,
            "name": name,
            "opacity": opacity,
            "type": type,
            "visible": visible,
            "width": width,
            "x": x,
            "y": y
        };

        if (data) {
            layer.data = data;
        }

        if (objects) {
            layer.objects = (objects);
        }

        return layer;

    },
    generate: function (height, width, tilewidth, tileheight, tilesets, layers) {
        return json = {
            "height": height,
            "layers": layers,
            "orientation": "orthogonal",
            "properties": {},
            "tileheight": tileheight,
            "tilesets": tilesets,
            "tilewidth": tilewidth,
            "version": 1,
            "width": width
        }

    }
};

},{"./utils":"/Users/tim/projects/TigerRetriever/src/js/utils.js"}],"/Users/tim/projects/TigerRetriever/src/js/main.js":[function(require,module,exports){
'use strict';
var game = new Phaser.Game(746, 280, Phaser.AUTO, 'TigerRetriever');

game.state.add('Boot', require('./states/boot'));
game.state.add('Preload', require('./states/preload'));
game.state.add('Game', require('./states/game'));
game.state.add('MainMenu', require('./states/mainmenu'));

game.state.start('Boot');
},{"./states/boot":"/Users/tim/projects/TigerRetriever/src/js/states/boot.js","./states/game":"/Users/tim/projects/TigerRetriever/src/js/states/game.js","./states/mainmenu":"/Users/tim/projects/TigerRetriever/src/js/states/mainmenu.js","./states/preload":"/Users/tim/projects/TigerRetriever/src/js/states/preload.js"}],"/Users/tim/projects/TigerRetriever/src/js/states/boot.js":[function(require,module,exports){
var Boot = function(){};

//setting game configuration and loading the assets for the loading screen
Boot.prototype = {
    preload: function() {
        //assets we'll use in the loading screen
        this.load.image('preloadbar', 'assets/images/preloader-bar.png'); // not made yet
    },
    create: function() {
        //loading screen will have a white background
        this.game.stage.backgroundColor = '#0066ff';

        //scaling options
        this.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;

        //have the game centered horizontally
        this.scale.pageAlignHorizontally = true;
        this.scale.pageAlignVertically = true;

        //screen size will be set automatically
        //this.scale.setScreenSize(true);

        //physics system
        this.game.physics.startSystem(Phaser.Physics.ARCADE);

        this.state.start('Preload');
    }
};

module.exports = Boot;
},{}],"/Users/tim/projects/TigerRetriever/src/js/states/game.js":[function(require,module,exports){

var Game = function(){
    this.INIT_HERD_SIZE = 3;
};

module.exports = Game;

Game.prototype = {
    preload: function() {
        this.game.time.advancedTiming = true;
    },
    create: function() {

        this.map = this.game.add.tilemap('level1');

        //the first parameter is the tileset name as specified in Tiled, the second is the key to the asset
        this.map.addTilesetImage('tiles_spritesheet', 'gameTiles');

        //create layers
        this.backgroundlayer = this.map.createLayer('backgroundLayer');
        this.blockedLayer = this.map.createLayer('blockedLayer');

        //collision on blockedLayer
        this.map.setCollisionBetween(1, 5000, true, 'blockedLayer');

        //resizes the game world to match the layer dimensions
        this.backgroundlayer.resizeWorld();

        //create the herd
        this.herd = new Game.Herd(this.INIT_HERD_SIZE, this.game);

        //the camera will follow the player in the world
        this.game.camera.follow(this.herd.cameraFocus());

        //move player with cursor keys
        this.cursors = this.game.input.keyboard.createCursorKeys();

        //sounds
        this.coinSound = this.game.add.audio('coin');
    },

    //find objects in a Tiled layer that containt a property called "type" equal to a certain value
    findObjectsByType: function(type, map, layerName) {
        var result = [];
        map.objects[layerName].forEach(function(element){
            if(element.properties.type === type) {
                //Phaser uses top left, Tiled bottom left so we have to adjust
                //also keep in mind that some images could be of different size as the tile size
                //so they might not be placed in the exact position as in Tiled
                element.y -= map.tileHeight;
                result.push(element);
            }
        });
        return result;
    },
    //create a sprite from an object
    createFromTiledObject: function(element, group) {
        var sprite = group.create(element.x, element.y, element.properties.sprite);

        //copy all properties to the sprite
        Object.keys(element.properties).forEach(function(key){
            sprite[key] = element.properties[key];
        });
    },
    update: function() {
        //collisions
        this.herd.forEach(function(animal) {
            this.game.physics.arcade.collide(animal, this.blockedLayer, this.animalHit, null, this);
        }, this);

        //only respond to keys and keep the speed if the player is alive
        //check herd still living animals
        var alive = false;
        this.herd.forEach(function (animal) {
            if (animal.alive) {
                alive = true;
            }
        });
        if(alive) {
            this.herd.forEach(function (animal) {
                animal.body.velocity.x = 300;
            });

            if(this.cursors.up.isDown) {
                this.playersJump();
            }
            else if(this.cursors.down.isDown) {
                this.playersDuck();
            }

            if(!this.cursors.down.isDown && this.herd[0].isDucked && !this.pressingDown) {
                //change image and update the body size for the physics engine
                this.herd.forEach(function (animal) {
                    animal.loadTexture('player');
                    animal.body.setSize(animal.standDimensions.width, animal.standDimensions.height);
                    animal.isDucked = false;
                });
            }

            //restart the game if reaching the edge
            if(this.herd[0].x >= this.game.world.width) {
                this.game.state.start('Game');
            }
        }

    },
    animalHit: function(animal, blockedLayer) {
        //if hits on the right side, die
        if(animal.body.blocked.right) {
            //set to dead (this doesn't affect rendering)
            animal.alive = false;

            //stop moving to the right
            animal.body.velocity.x = 0;

            //change sprite image
            animal.loadTexture('playerDead');

            //check herd still living animals
            var gameOver = true;
            this.herd.forEach(function (animal) {
                if (animal.alive) {
                    gameOver = false;
                }
            });

            //go to gameover after a few miliseconds
            if (gameOver) {
                this.game.time.events.add(1500, this.gameOver, this);
            }
        }
    },
    gameOver: function() {
        this.game.state.start('Game');
    },
    playersJump: function() {
        this.herd.forEach(function (animal) {
            if (animal.body.blocked.down) {
                animal.body.velocity.y -= 700;
            }
        });
    },
    playersDuck: function() {
        this.herd.forEach(function (animal) {
           //change image and update the body size for the physics engine
           animal.loadTexture('playerDuck');
           animal.body.setSize(animal.duckedDimensions.width, animal.duckedDimensions.height);

           //we use this to keep track whether it's ducked or not
           animal.isDucked = true;
        });
    },
    render: function()
    {
        this.game.debug.text(this.game.time.fps || '--', 20, 70, "#00ff00", "40px Courier");
        this.herd.forEach(function (animal) {
            this .game.debug.bodyInfo(animal, 0, 80);
        }, this);
    }
};

Game.Herd = function (size, game) {
    this.game = game;

    for (i = 0; i < size; i++) {
        //make new member of the herd
        var member = this.game.add.sprite(100 + i * 50, 100, 'player');

        //enable physics on the member
        this.game.physics.arcade.enable(member);

        //player gravity
        member.body.gravity.y = 1000;

        //properties when the member is ducked and standing, so we can use in update()
        var playerDuckImg = this.game.cache.getImage('playerDuck');
        member.duckedDimensions = {width: playerDuckImg.width, height: playerDuckImg.height};
        member.standDimensions = {width: member.width, height: member.height};
        member.anchor.setTo(0.5, 1);

        this.push(member);
    }
};

//use an array as the base of the new object
Game.Herd.prototype = Array.prototype;

//focus is on the leading member
Game.Herd.prototype.cameraFocus = function() {
    var lead = this[0];
    for (i = 1; i < this.length; i++) {
        if (this[i].x > lead.x) {
            lead = this[i];
        }
    }
    return lead;
};

},{}],"/Users/tim/projects/TigerRetriever/src/js/states/mainmenu.js":[function(require,module,exports){
var MainMenu = function(){};
module.exports = MainMenu;

MainMenu.prototype = {
    preload: function() {
        //show loading screen
    },
    create: function() {
        var xPosition = 340;
        var yPosition = 60;

        this.playText = this.game.add.text(xPosition, yPosition, 'Play', { fontSize: '32px', fill: '#000' });
        this.instructionsText = this.game.add.text(xPosition, yPosition + 60, 'Instructions', { fontSize: '32px', fill: '#000' });
        this.pandaText = this.game.add.text(xPosition, yPosition + 120, 'Hug a Panda', { fontSize: '32px', fill: '#000' });
    },
    update: function () {

    }
};
},{}],"/Users/tim/projects/TigerRetriever/src/js/states/preload.js":[function(require,module,exports){
//loading the game assets
var Preload = function(){};
module.exports = Preload;

Preload.prototype = {
    preload: function() {
        //show loading screen
        this.preloadBar = this.add.sprite(this.game.world.centerX, this.game.world.centerY, 'preloadbar');
        this.preloadBar.anchor.setTo(0.5);
        this.preloadBar.scale.setTo(3);

        this.load.setPreloadSprite(this.preloadBar);

        var levelJson = JSON.stringify(require('../jsongenerator').recreateInitialJson());

        this.load.tilemap('level1', null, levelJson, Phaser.Tilemap.TILED_JSON);
        this.load.image('gameTiles', 'assets/images/background_spritesheet.png');
        this.load.image('player', 'assets/images/player.png');
        this.load.image('playerDuck', 'assets/images/player_duck.png');
        this.load.image('playerDead', 'assets/images/player_dead.png');

    },
    create: function() {
        this.state.start('Game');
    }
};
},{"../jsongenerator":"/Users/tim/projects/TigerRetriever/src/js/jsongenerator.js"}],"/Users/tim/projects/TigerRetriever/src/js/utils.js":[function(require,module,exports){
var utils = function () {
};
module.exports = utils;

utils.prototype = {
    getRandomInt: function (min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    },

    get_type: function (thing) {
        if (thing === null)return "[object Null]"; // special case
        return Object.prototype.toString.call(thing);
    }
};
},{}]},{},["/Users/tim/projects/TigerRetriever/src/js/main.js"])
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9icm93c2VyLXBhY2svX3ByZWx1ZGUuanMiLCJzcmMvanMvanNvbmdlbmVyYXRvci5qcyIsInNyYy9qcy9tYWluLmpzIiwic3JjL2pzL3N0YXRlcy9ib290LmpzIiwic3JjL2pzL3N0YXRlcy9nYW1lLmpzIiwic3JjL2pzL3N0YXRlcy9tYWlubWVudS5qcyIsInNyYy9qcy9zdGF0ZXMvcHJlbG9hZC5qcyIsInNyYy9qcy91dGlscy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQ0FBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNqSEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ1JBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUM3QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ3JNQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNsQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUN6QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJnZW5lcmF0ZWQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uIGUodCxuLHIpe2Z1bmN0aW9uIHMobyx1KXtpZighbltvXSl7aWYoIXRbb10pe3ZhciBhPXR5cGVvZiByZXF1aXJlPT1cImZ1bmN0aW9uXCImJnJlcXVpcmU7aWYoIXUmJmEpcmV0dXJuIGEobywhMCk7aWYoaSlyZXR1cm4gaShvLCEwKTt2YXIgZj1uZXcgRXJyb3IoXCJDYW5ub3QgZmluZCBtb2R1bGUgJ1wiK28rXCInXCIpO3Rocm93IGYuY29kZT1cIk1PRFVMRV9OT1RfRk9VTkRcIixmfXZhciBsPW5bb109e2V4cG9ydHM6e319O3Rbb11bMF0uY2FsbChsLmV4cG9ydHMsZnVuY3Rpb24oZSl7dmFyIG49dFtvXVsxXVtlXTtyZXR1cm4gcyhuP246ZSl9LGwsbC5leHBvcnRzLGUsdCxuLHIpfXJldHVybiBuW29dLmV4cG9ydHN9dmFyIGk9dHlwZW9mIHJlcXVpcmU9PVwiZnVuY3Rpb25cIiYmcmVxdWlyZTtmb3IodmFyIG89MDtvPHIubGVuZ3RoO28rKylzKHJbb10pO3JldHVybiBzfSkiLCJ2YXIgSnNvbkdlbmVyYXRvciA9IGZ1bmN0aW9uICgpIHt9O1xubW9kdWxlLmV4cG9ydHMgPSBKc29uR2VuZXJhdG9yO1xuXG52YXIgbWFwSGVpZ2h0ID0gNjtcbnZhciBtaW5MYW5kID0gNDtcbnZhciBtYXhHYXAgPSAzO1xudmFyIHRpbGVXaWR0aCA9IDQ1O1xudmFyIHRpbGVIZWlnaHQgPSA0NTtcbnZhciBtYXBXaWR0aCA9IDMwMDtcblxuSnNvbkdlbmVyYXRvci5wcm90b3R5cGUgPSB7XG5cblxuICAgIHJlY3JlYXRlSW5pdGlhbEpzb246IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdmFyIGxheWVycyA9IFtdO1xuICAgICAgICB2YXIgdGlsZXNldHMgPSBbXTtcbiAgICAgICAgdmFyIGJhY2tncm91bmQgPSBuZXcgQXJyYXkobWFwV2lkdGggKiBtYXBIZWlnaHQpO1xuICAgICAgICBiYWNrZ3JvdW5kLmZpbGwoMTM5KTtcblxuICAgICAgICBsYXllcnMucHVzaCh0aGlzLm1ha2VMYXllcihiYWNrZ3JvdW5kLCBtYXBIZWlnaHQsIFwiYmFja2dyb3VuZExheWVyXCIsIDEsIFwidGlsZWxheWVyXCIsIHRydWUsIG1hcFdpZHRoLCAwLCAwKSk7XG4gICAgICAgIGxheWVycy5wdXNoKHRoaXMubWFrZUxheWVyKHRoaXMubWFrZU1hcEJhc2UoKSwgbWFwSGVpZ2h0LCBcImJsb2NrZWRMYXllclwiLCAxLCBcInRpbGVsYXllclwiLCB0cnVlLCBtYXBXaWR0aCwgMCwgMCkpO1xuXG4gICAgICAgIHRpbGVzZXRzLnB1c2godGhpcy5tYWtlVGlsZXNldCgxLCBcIi4uXFwvaW1hZ2VzXFwvdGlsZXNfc3ByaXRlc2hlZXQucG5nXCIsIDkzNCwgNzkwLCAwLCBcInRpbGVzX3Nwcml0ZXNoZWV0XCIsIDIsXG4gICAgICAgICAgICB0aWxlV2lkdGgsIHRpbGVIZWlnaHQpKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5nZW5lcmF0ZShtYXBIZWlnaHQsIG1hcFdpZHRoLCB0aWxlV2lkdGgsIHRpbGVIZWlnaHQsIHRpbGVzZXRzLCBsYXllcnMpO1xuICAgIH0sXG4gICAgbWFrZVRpbGVzZXQ6IGZ1bmN0aW9uIChmaXJzdGdpZCwgaW1hZ2VMb2NhdGlvbiwgaW1hZ2VIZWlnaHQsIGltYWdlV2lkdGgsIG1hcmdpbiwgbmFtZSwgc3BhY2luZywgdGlsZUhlaWdodCwgdGlsZVdpZHRoKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBcImZpcnN0Z2lkXCI6IGZpcnN0Z2lkLFxuICAgICAgICAgICAgXCJpbWFnZVwiOiBpbWFnZUxvY2F0aW9uLFxuICAgICAgICAgICAgXCJpbWFnZWhlaWdodFwiOiBpbWFnZUhlaWdodCxcbiAgICAgICAgICAgIFwiaW1hZ2V3aWR0aFwiOiBpbWFnZVdpZHRoLFxuICAgICAgICAgICAgXCJtYXJnaW5cIjogbWFyZ2luLFxuICAgICAgICAgICAgXCJuYW1lXCI6IG5hbWUsXG4gICAgICAgICAgICBcInByb3BlcnRpZXNcIjoge30sXG4gICAgICAgICAgICBcInNwYWNpbmdcIjogc3BhY2luZyxcbiAgICAgICAgICAgIFwidGlsZWhlaWdodFwiOiB0aWxlSGVpZ2h0LFxuICAgICAgICAgICAgXCJ0aWxld2lkdGhcIjogdGlsZVdpZHRoXG4gICAgICAgIH07XG4gICAgfSxcbiAgICBtYWtlTWFwQmFzZTogZnVuY3Rpb24gKCkge1xuICAgICAgICB2YXIgdXRpbHMgPSByZXF1aXJlKCcuL3V0aWxzJyk7XG4gICAgICAgIHZhciBnYXBDb3VudCA9IDA7XG4gICAgICAgIHZhciBsYW5kQ291bnQgPSA1O1xuICAgICAgICB2YXIgbWFwQmFzZSA9IG5ldyBBcnJheShtYXBXaWR0aCAqIG1hcEhlaWdodCk7XG4gICAgICAgIG1hcEJhc2UuZmlsbCgwKTtcblxuICAgICAgICB2YXIgc3RhcnRJbmRleCA9IChtYXBIZWlnaHQgLSAxKSAqIG1hcFdpZHRoO1xuICAgICAgICB2YXIgbWF4SW5kZXggPSBtYXBXaWR0aCAqIG1hcEhlaWdodDtcblxuICAgICAgICBtYXBCYXNlLmZpbGwoMSwgc3RhcnRJbmRleCwgc3RhcnRJbmRleCArIDE1KTtcbiAgICAgICAgbWFwQmFzZS5maWxsKDEsIG1heEluZGV4IC0gMTUsIG1heEluZGV4KTtcblxuICAgICAgICAvLyBHZW5lcmF0ZSBhcnJheSBmb3IgbWFwXG4gICAgICAgIC8vIDEgPSBsYW5kLCAwID0gZ2FwXG4gICAgICAgIGZvciAoaSA9IHN0YXJ0SW5kZXggKyAxNTsgaSA8IG1heEluZGV4IC0gMTU7IGkrKykge1xuICAgICAgICAgICAgaWYgKGxhbmRDb3VudCA8IG1pbkxhbmQgJiYgbGFuZENvdW50ID4gMCkge1xuICAgICAgICAgICAgICAgIG1hcEJhc2VbaV0gPSAxO1xuICAgICAgICAgICAgICAgIGxhbmRDb3VudCsrO1xuICAgICAgICAgICAgICAgIGdhcENvdW50ID0gMDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKHV0aWxzLmdldFJhbmRvbUludCgwLCAxKSA9PSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIGdhcENvdW50Kys7XG4gICAgICAgICAgICAgICAgICAgIG1hcEJhc2VbaV0gPSAwO1xuICAgICAgICAgICAgICAgICAgICBsYW5kQ291bnQgPSAwO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIG1hcEJhc2VbaV0gPSAxO1xuICAgICAgICAgICAgICAgICAgICBsYW5kQ291bnQrKztcbiAgICAgICAgICAgICAgICAgICAgZ2FwQ291bnQgPSAwO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbWFwQmFzZTtcbiAgICB9LFxuICAgIG1ha2VMYXllcjogZnVuY3Rpb24gKGRhdGEsIGhlaWdodCwgbmFtZSwgb3BhY2l0eSwgdHlwZSwgdmlzaWJsZSwgd2lkdGgsIHgsIHksIG9iamVjdHMpIHtcbiAgICAgICAgbGF5ZXIgPSB7XG4gICAgICAgICAgICBcImhlaWdodFwiOiBoZWlnaHQsXG4gICAgICAgICAgICBcIm5hbWVcIjogbmFtZSxcbiAgICAgICAgICAgIFwib3BhY2l0eVwiOiBvcGFjaXR5LFxuICAgICAgICAgICAgXCJ0eXBlXCI6IHR5cGUsXG4gICAgICAgICAgICBcInZpc2libGVcIjogdmlzaWJsZSxcbiAgICAgICAgICAgIFwid2lkdGhcIjogd2lkdGgsXG4gICAgICAgICAgICBcInhcIjogeCxcbiAgICAgICAgICAgIFwieVwiOiB5XG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKGRhdGEpIHtcbiAgICAgICAgICAgIGxheWVyLmRhdGEgPSBkYXRhO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKG9iamVjdHMpIHtcbiAgICAgICAgICAgIGxheWVyLm9iamVjdHMgPSAob2JqZWN0cyk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbGF5ZXI7XG5cbiAgICB9LFxuICAgIGdlbmVyYXRlOiBmdW5jdGlvbiAoaGVpZ2h0LCB3aWR0aCwgdGlsZXdpZHRoLCB0aWxlaGVpZ2h0LCB0aWxlc2V0cywgbGF5ZXJzKSB7XG4gICAgICAgIHJldHVybiBqc29uID0ge1xuICAgICAgICAgICAgXCJoZWlnaHRcIjogaGVpZ2h0LFxuICAgICAgICAgICAgXCJsYXllcnNcIjogbGF5ZXJzLFxuICAgICAgICAgICAgXCJvcmllbnRhdGlvblwiOiBcIm9ydGhvZ29uYWxcIixcbiAgICAgICAgICAgIFwicHJvcGVydGllc1wiOiB7fSxcbiAgICAgICAgICAgIFwidGlsZWhlaWdodFwiOiB0aWxlaGVpZ2h0LFxuICAgICAgICAgICAgXCJ0aWxlc2V0c1wiOiB0aWxlc2V0cyxcbiAgICAgICAgICAgIFwidGlsZXdpZHRoXCI6IHRpbGV3aWR0aCxcbiAgICAgICAgICAgIFwidmVyc2lvblwiOiAxLFxuICAgICAgICAgICAgXCJ3aWR0aFwiOiB3aWR0aFxuICAgICAgICB9XG5cbiAgICB9XG59O1xuIiwiJ3VzZSBzdHJpY3QnO1xudmFyIGdhbWUgPSBuZXcgUGhhc2VyLkdhbWUoNzQ2LCAyODAsIFBoYXNlci5BVVRPLCAnVGlnZXJSZXRyaWV2ZXInKTtcblxuZ2FtZS5zdGF0ZS5hZGQoJ0Jvb3QnLCByZXF1aXJlKCcuL3N0YXRlcy9ib290JykpO1xuZ2FtZS5zdGF0ZS5hZGQoJ1ByZWxvYWQnLCByZXF1aXJlKCcuL3N0YXRlcy9wcmVsb2FkJykpO1xuZ2FtZS5zdGF0ZS5hZGQoJ0dhbWUnLCByZXF1aXJlKCcuL3N0YXRlcy9nYW1lJykpO1xuZ2FtZS5zdGF0ZS5hZGQoJ01haW5NZW51JywgcmVxdWlyZSgnLi9zdGF0ZXMvbWFpbm1lbnUnKSk7XG5cbmdhbWUuc3RhdGUuc3RhcnQoJ0Jvb3QnKTsiLCJ2YXIgQm9vdCA9IGZ1bmN0aW9uKCl7fTtcblxuLy9zZXR0aW5nIGdhbWUgY29uZmlndXJhdGlvbiBhbmQgbG9hZGluZyB0aGUgYXNzZXRzIGZvciB0aGUgbG9hZGluZyBzY3JlZW5cbkJvb3QucHJvdG90eXBlID0ge1xuICAgIHByZWxvYWQ6IGZ1bmN0aW9uKCkge1xuICAgICAgICAvL2Fzc2V0cyB3ZSdsbCB1c2UgaW4gdGhlIGxvYWRpbmcgc2NyZWVuXG4gICAgICAgIHRoaXMubG9hZC5pbWFnZSgncHJlbG9hZGJhcicsICdhc3NldHMvaW1hZ2VzL3ByZWxvYWRlci1iYXIucG5nJyk7IC8vIG5vdCBtYWRlIHlldFxuICAgIH0sXG4gICAgY3JlYXRlOiBmdW5jdGlvbigpIHtcbiAgICAgICAgLy9sb2FkaW5nIHNjcmVlbiB3aWxsIGhhdmUgYSB3aGl0ZSBiYWNrZ3JvdW5kXG4gICAgICAgIHRoaXMuZ2FtZS5zdGFnZS5iYWNrZ3JvdW5kQ29sb3IgPSAnIzAwNjZmZic7XG5cbiAgICAgICAgLy9zY2FsaW5nIG9wdGlvbnNcbiAgICAgICAgdGhpcy5zY2FsZS5zY2FsZU1vZGUgPSBQaGFzZXIuU2NhbGVNYW5hZ2VyLlNIT1dfQUxMO1xuXG4gICAgICAgIC8vaGF2ZSB0aGUgZ2FtZSBjZW50ZXJlZCBob3Jpem9udGFsbHlcbiAgICAgICAgdGhpcy5zY2FsZS5wYWdlQWxpZ25Ib3Jpem9udGFsbHkgPSB0cnVlO1xuICAgICAgICB0aGlzLnNjYWxlLnBhZ2VBbGlnblZlcnRpY2FsbHkgPSB0cnVlO1xuXG4gICAgICAgIC8vc2NyZWVuIHNpemUgd2lsbCBiZSBzZXQgYXV0b21hdGljYWxseVxuICAgICAgICAvL3RoaXMuc2NhbGUuc2V0U2NyZWVuU2l6ZSh0cnVlKTtcblxuICAgICAgICAvL3BoeXNpY3Mgc3lzdGVtXG4gICAgICAgIHRoaXMuZ2FtZS5waHlzaWNzLnN0YXJ0U3lzdGVtKFBoYXNlci5QaHlzaWNzLkFSQ0FERSk7XG5cbiAgICAgICAgdGhpcy5zdGF0ZS5zdGFydCgnUHJlbG9hZCcpO1xuICAgIH1cbn07XG5cbm1vZHVsZS5leHBvcnRzID0gQm9vdDsiLCJcbnZhciBHYW1lID0gZnVuY3Rpb24oKXtcbiAgICB0aGlzLklOSVRfSEVSRF9TSVpFID0gMztcbn07XG5cbm1vZHVsZS5leHBvcnRzID0gR2FtZTtcblxuR2FtZS5wcm90b3R5cGUgPSB7XG4gICAgcHJlbG9hZDogZnVuY3Rpb24oKSB7XG4gICAgICAgIHRoaXMuZ2FtZS50aW1lLmFkdmFuY2VkVGltaW5nID0gdHJ1ZTtcbiAgICB9LFxuICAgIGNyZWF0ZTogZnVuY3Rpb24oKSB7XG5cbiAgICAgICAgdGhpcy5tYXAgPSB0aGlzLmdhbWUuYWRkLnRpbGVtYXAoJ2xldmVsMScpO1xuXG4gICAgICAgIC8vdGhlIGZpcnN0IHBhcmFtZXRlciBpcyB0aGUgdGlsZXNldCBuYW1lIGFzIHNwZWNpZmllZCBpbiBUaWxlZCwgdGhlIHNlY29uZCBpcyB0aGUga2V5IHRvIHRoZSBhc3NldFxuICAgICAgICB0aGlzLm1hcC5hZGRUaWxlc2V0SW1hZ2UoJ3RpbGVzX3Nwcml0ZXNoZWV0JywgJ2dhbWVUaWxlcycpO1xuXG4gICAgICAgIC8vY3JlYXRlIGxheWVyc1xuICAgICAgICB0aGlzLmJhY2tncm91bmRsYXllciA9IHRoaXMubWFwLmNyZWF0ZUxheWVyKCdiYWNrZ3JvdW5kTGF5ZXInKTtcbiAgICAgICAgdGhpcy5ibG9ja2VkTGF5ZXIgPSB0aGlzLm1hcC5jcmVhdGVMYXllcignYmxvY2tlZExheWVyJyk7XG5cbiAgICAgICAgLy9jb2xsaXNpb24gb24gYmxvY2tlZExheWVyXG4gICAgICAgIHRoaXMubWFwLnNldENvbGxpc2lvbkJldHdlZW4oMSwgNTAwMCwgdHJ1ZSwgJ2Jsb2NrZWRMYXllcicpO1xuXG4gICAgICAgIC8vcmVzaXplcyB0aGUgZ2FtZSB3b3JsZCB0byBtYXRjaCB0aGUgbGF5ZXIgZGltZW5zaW9uc1xuICAgICAgICB0aGlzLmJhY2tncm91bmRsYXllci5yZXNpemVXb3JsZCgpO1xuXG4gICAgICAgIC8vY3JlYXRlIHRoZSBoZXJkXG4gICAgICAgIHRoaXMuaGVyZCA9IG5ldyBHYW1lLkhlcmQodGhpcy5JTklUX0hFUkRfU0laRSwgdGhpcy5nYW1lKTtcblxuICAgICAgICAvL3RoZSBjYW1lcmEgd2lsbCBmb2xsb3cgdGhlIHBsYXllciBpbiB0aGUgd29ybGRcbiAgICAgICAgdGhpcy5nYW1lLmNhbWVyYS5mb2xsb3codGhpcy5oZXJkLmNhbWVyYUZvY3VzKCkpO1xuXG4gICAgICAgIC8vbW92ZSBwbGF5ZXIgd2l0aCBjdXJzb3Iga2V5c1xuICAgICAgICB0aGlzLmN1cnNvcnMgPSB0aGlzLmdhbWUuaW5wdXQua2V5Ym9hcmQuY3JlYXRlQ3Vyc29yS2V5cygpO1xuXG4gICAgICAgIC8vc291bmRzXG4gICAgICAgIHRoaXMuY29pblNvdW5kID0gdGhpcy5nYW1lLmFkZC5hdWRpbygnY29pbicpO1xuICAgIH0sXG5cbiAgICAvL2ZpbmQgb2JqZWN0cyBpbiBhIFRpbGVkIGxheWVyIHRoYXQgY29udGFpbnQgYSBwcm9wZXJ0eSBjYWxsZWQgXCJ0eXBlXCIgZXF1YWwgdG8gYSBjZXJ0YWluIHZhbHVlXG4gICAgZmluZE9iamVjdHNCeVR5cGU6IGZ1bmN0aW9uKHR5cGUsIG1hcCwgbGF5ZXJOYW1lKSB7XG4gICAgICAgIHZhciByZXN1bHQgPSBbXTtcbiAgICAgICAgbWFwLm9iamVjdHNbbGF5ZXJOYW1lXS5mb3JFYWNoKGZ1bmN0aW9uKGVsZW1lbnQpe1xuICAgICAgICAgICAgaWYoZWxlbWVudC5wcm9wZXJ0aWVzLnR5cGUgPT09IHR5cGUpIHtcbiAgICAgICAgICAgICAgICAvL1BoYXNlciB1c2VzIHRvcCBsZWZ0LCBUaWxlZCBib3R0b20gbGVmdCBzbyB3ZSBoYXZlIHRvIGFkanVzdFxuICAgICAgICAgICAgICAgIC8vYWxzbyBrZWVwIGluIG1pbmQgdGhhdCBzb21lIGltYWdlcyBjb3VsZCBiZSBvZiBkaWZmZXJlbnQgc2l6ZSBhcyB0aGUgdGlsZSBzaXplXG4gICAgICAgICAgICAgICAgLy9zbyB0aGV5IG1pZ2h0IG5vdCBiZSBwbGFjZWQgaW4gdGhlIGV4YWN0IHBvc2l0aW9uIGFzIGluIFRpbGVkXG4gICAgICAgICAgICAgICAgZWxlbWVudC55IC09IG1hcC50aWxlSGVpZ2h0O1xuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGVsZW1lbnQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9LFxuICAgIC8vY3JlYXRlIGEgc3ByaXRlIGZyb20gYW4gb2JqZWN0XG4gICAgY3JlYXRlRnJvbVRpbGVkT2JqZWN0OiBmdW5jdGlvbihlbGVtZW50LCBncm91cCkge1xuICAgICAgICB2YXIgc3ByaXRlID0gZ3JvdXAuY3JlYXRlKGVsZW1lbnQueCwgZWxlbWVudC55LCBlbGVtZW50LnByb3BlcnRpZXMuc3ByaXRlKTtcblxuICAgICAgICAvL2NvcHkgYWxsIHByb3BlcnRpZXMgdG8gdGhlIHNwcml0ZVxuICAgICAgICBPYmplY3Qua2V5cyhlbGVtZW50LnByb3BlcnRpZXMpLmZvckVhY2goZnVuY3Rpb24oa2V5KXtcbiAgICAgICAgICAgIHNwcml0ZVtrZXldID0gZWxlbWVudC5wcm9wZXJ0aWVzW2tleV07XG4gICAgICAgIH0pO1xuICAgIH0sXG4gICAgdXBkYXRlOiBmdW5jdGlvbigpIHtcbiAgICAgICAgLy9jb2xsaXNpb25zXG4gICAgICAgIHRoaXMuaGVyZC5mb3JFYWNoKGZ1bmN0aW9uKGFuaW1hbCkge1xuICAgICAgICAgICAgdGhpcy5nYW1lLnBoeXNpY3MuYXJjYWRlLmNvbGxpZGUoYW5pbWFsLCB0aGlzLmJsb2NrZWRMYXllciwgdGhpcy5hbmltYWxIaXQsIG51bGwsIHRoaXMpO1xuICAgICAgICB9LCB0aGlzKTtcblxuICAgICAgICAvL29ubHkgcmVzcG9uZCB0byBrZXlzIGFuZCBrZWVwIHRoZSBzcGVlZCBpZiB0aGUgcGxheWVyIGlzIGFsaXZlXG4gICAgICAgIC8vY2hlY2sgaGVyZCBzdGlsbCBsaXZpbmcgYW5pbWFsc1xuICAgICAgICB2YXIgYWxpdmUgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5oZXJkLmZvckVhY2goZnVuY3Rpb24gKGFuaW1hbCkge1xuICAgICAgICAgICAgaWYgKGFuaW1hbC5hbGl2ZSkge1xuICAgICAgICAgICAgICAgIGFsaXZlID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIGlmKGFsaXZlKSB7XG4gICAgICAgICAgICB0aGlzLmhlcmQuZm9yRWFjaChmdW5jdGlvbiAoYW5pbWFsKSB7XG4gICAgICAgICAgICAgICAgYW5pbWFsLmJvZHkudmVsb2NpdHkueCA9IDMwMDtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBpZih0aGlzLmN1cnNvcnMudXAuaXNEb3duKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5wbGF5ZXJzSnVtcCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZih0aGlzLmN1cnNvcnMuZG93bi5pc0Rvd24pIHtcbiAgICAgICAgICAgICAgICB0aGlzLnBsYXllcnNEdWNrKCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmKCF0aGlzLmN1cnNvcnMuZG93bi5pc0Rvd24gJiYgdGhpcy5oZXJkWzBdLmlzRHVja2VkICYmICF0aGlzLnByZXNzaW5nRG93bikge1xuICAgICAgICAgICAgICAgIC8vY2hhbmdlIGltYWdlIGFuZCB1cGRhdGUgdGhlIGJvZHkgc2l6ZSBmb3IgdGhlIHBoeXNpY3MgZW5naW5lXG4gICAgICAgICAgICAgICAgdGhpcy5oZXJkLmZvckVhY2goZnVuY3Rpb24gKGFuaW1hbCkge1xuICAgICAgICAgICAgICAgICAgICBhbmltYWwubG9hZFRleHR1cmUoJ3BsYXllcicpO1xuICAgICAgICAgICAgICAgICAgICBhbmltYWwuYm9keS5zZXRTaXplKGFuaW1hbC5zdGFuZERpbWVuc2lvbnMud2lkdGgsIGFuaW1hbC5zdGFuZERpbWVuc2lvbnMuaGVpZ2h0KTtcbiAgICAgICAgICAgICAgICAgICAgYW5pbWFsLmlzRHVja2VkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vcmVzdGFydCB0aGUgZ2FtZSBpZiByZWFjaGluZyB0aGUgZWRnZVxuICAgICAgICAgICAgaWYodGhpcy5oZXJkWzBdLnggPj0gdGhpcy5nYW1lLndvcmxkLndpZHRoKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YXRlLnN0YXJ0KCdHYW1lJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgIH0sXG4gICAgYW5pbWFsSGl0OiBmdW5jdGlvbihhbmltYWwsIGJsb2NrZWRMYXllcikge1xuICAgICAgICAvL2lmIGhpdHMgb24gdGhlIHJpZ2h0IHNpZGUsIGRpZVxuICAgICAgICBpZihhbmltYWwuYm9keS5ibG9ja2VkLnJpZ2h0KSB7XG4gICAgICAgICAgICAvL3NldCB0byBkZWFkICh0aGlzIGRvZXNuJ3QgYWZmZWN0IHJlbmRlcmluZylcbiAgICAgICAgICAgIGFuaW1hbC5hbGl2ZSA9IGZhbHNlO1xuXG4gICAgICAgICAgICAvL3N0b3AgbW92aW5nIHRvIHRoZSByaWdodFxuICAgICAgICAgICAgYW5pbWFsLmJvZHkudmVsb2NpdHkueCA9IDA7XG5cbiAgICAgICAgICAgIC8vY2hhbmdlIHNwcml0ZSBpbWFnZVxuICAgICAgICAgICAgYW5pbWFsLmxvYWRUZXh0dXJlKCdwbGF5ZXJEZWFkJyk7XG5cbiAgICAgICAgICAgIC8vY2hlY2sgaGVyZCBzdGlsbCBsaXZpbmcgYW5pbWFsc1xuICAgICAgICAgICAgdmFyIGdhbWVPdmVyID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMuaGVyZC5mb3JFYWNoKGZ1bmN0aW9uIChhbmltYWwpIHtcbiAgICAgICAgICAgICAgICBpZiAoYW5pbWFsLmFsaXZlKSB7XG4gICAgICAgICAgICAgICAgICAgIGdhbWVPdmVyID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIC8vZ28gdG8gZ2FtZW92ZXIgYWZ0ZXIgYSBmZXcgbWlsaXNlY29uZHNcbiAgICAgICAgICAgIGlmIChnYW1lT3Zlcikge1xuICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS50aW1lLmV2ZW50cy5hZGQoMTUwMCwgdGhpcy5nYW1lT3ZlciwgdGhpcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9LFxuICAgIGdhbWVPdmVyOiBmdW5jdGlvbigpIHtcbiAgICAgICAgdGhpcy5nYW1lLnN0YXRlLnN0YXJ0KCdHYW1lJyk7XG4gICAgfSxcbiAgICBwbGF5ZXJzSnVtcDogZnVuY3Rpb24oKSB7XG4gICAgICAgIHRoaXMuaGVyZC5mb3JFYWNoKGZ1bmN0aW9uIChhbmltYWwpIHtcbiAgICAgICAgICAgIGlmIChhbmltYWwuYm9keS5ibG9ja2VkLmRvd24pIHtcbiAgICAgICAgICAgICAgICBhbmltYWwuYm9keS52ZWxvY2l0eS55IC09IDcwMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfSxcbiAgICBwbGF5ZXJzRHVjazogZnVuY3Rpb24oKSB7XG4gICAgICAgIHRoaXMuaGVyZC5mb3JFYWNoKGZ1bmN0aW9uIChhbmltYWwpIHtcbiAgICAgICAgICAgLy9jaGFuZ2UgaW1hZ2UgYW5kIHVwZGF0ZSB0aGUgYm9keSBzaXplIGZvciB0aGUgcGh5c2ljcyBlbmdpbmVcbiAgICAgICAgICAgYW5pbWFsLmxvYWRUZXh0dXJlKCdwbGF5ZXJEdWNrJyk7XG4gICAgICAgICAgIGFuaW1hbC5ib2R5LnNldFNpemUoYW5pbWFsLmR1Y2tlZERpbWVuc2lvbnMud2lkdGgsIGFuaW1hbC5kdWNrZWREaW1lbnNpb25zLmhlaWdodCk7XG5cbiAgICAgICAgICAgLy93ZSB1c2UgdGhpcyB0byBrZWVwIHRyYWNrIHdoZXRoZXIgaXQncyBkdWNrZWQgb3Igbm90XG4gICAgICAgICAgIGFuaW1hbC5pc0R1Y2tlZCA9IHRydWU7XG4gICAgICAgIH0pO1xuICAgIH0sXG4gICAgcmVuZGVyOiBmdW5jdGlvbigpXG4gICAge1xuICAgICAgICB0aGlzLmdhbWUuZGVidWcudGV4dCh0aGlzLmdhbWUudGltZS5mcHMgfHwgJy0tJywgMjAsIDcwLCBcIiMwMGZmMDBcIiwgXCI0MHB4IENvdXJpZXJcIik7XG4gICAgICAgIHRoaXMuaGVyZC5mb3JFYWNoKGZ1bmN0aW9uIChhbmltYWwpIHtcbiAgICAgICAgICAgIHRoaXMgLmdhbWUuZGVidWcuYm9keUluZm8oYW5pbWFsLCAwLCA4MCk7XG4gICAgICAgIH0sIHRoaXMpO1xuICAgIH1cbn07XG5cbkdhbWUuSGVyZCA9IGZ1bmN0aW9uIChzaXplLCBnYW1lKSB7XG4gICAgdGhpcy5nYW1lID0gZ2FtZTtcblxuICAgIGZvciAoaSA9IDA7IGkgPCBzaXplOyBpKyspIHtcbiAgICAgICAgLy9tYWtlIG5ldyBtZW1iZXIgb2YgdGhlIGhlcmRcbiAgICAgICAgdmFyIG1lbWJlciA9IHRoaXMuZ2FtZS5hZGQuc3ByaXRlKDEwMCArIGkgKiA1MCwgMTAwLCAncGxheWVyJyk7XG5cbiAgICAgICAgLy9lbmFibGUgcGh5c2ljcyBvbiB0aGUgbWVtYmVyXG4gICAgICAgIHRoaXMuZ2FtZS5waHlzaWNzLmFyY2FkZS5lbmFibGUobWVtYmVyKTtcblxuICAgICAgICAvL3BsYXllciBncmF2aXR5XG4gICAgICAgIG1lbWJlci5ib2R5LmdyYXZpdHkueSA9IDEwMDA7XG5cbiAgICAgICAgLy9wcm9wZXJ0aWVzIHdoZW4gdGhlIG1lbWJlciBpcyBkdWNrZWQgYW5kIHN0YW5kaW5nLCBzbyB3ZSBjYW4gdXNlIGluIHVwZGF0ZSgpXG4gICAgICAgIHZhciBwbGF5ZXJEdWNrSW1nID0gdGhpcy5nYW1lLmNhY2hlLmdldEltYWdlKCdwbGF5ZXJEdWNrJyk7XG4gICAgICAgIG1lbWJlci5kdWNrZWREaW1lbnNpb25zID0ge3dpZHRoOiBwbGF5ZXJEdWNrSW1nLndpZHRoLCBoZWlnaHQ6IHBsYXllckR1Y2tJbWcuaGVpZ2h0fTtcbiAgICAgICAgbWVtYmVyLnN0YW5kRGltZW5zaW9ucyA9IHt3aWR0aDogbWVtYmVyLndpZHRoLCBoZWlnaHQ6IG1lbWJlci5oZWlnaHR9O1xuICAgICAgICBtZW1iZXIuYW5jaG9yLnNldFRvKDAuNSwgMSk7XG5cbiAgICAgICAgdGhpcy5wdXNoKG1lbWJlcik7XG4gICAgfVxufTtcblxuLy91c2UgYW4gYXJyYXkgYXMgdGhlIGJhc2Ugb2YgdGhlIG5ldyBvYmplY3RcbkdhbWUuSGVyZC5wcm90b3R5cGUgPSBBcnJheS5wcm90b3R5cGU7XG5cbi8vZm9jdXMgaXMgb24gdGhlIGxlYWRpbmcgbWVtYmVyXG5HYW1lLkhlcmQucHJvdG90eXBlLmNhbWVyYUZvY3VzID0gZnVuY3Rpb24oKSB7XG4gICAgdmFyIGxlYWQgPSB0aGlzWzBdO1xuICAgIGZvciAoaSA9IDE7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGlmICh0aGlzW2ldLnggPiBsZWFkLngpIHtcbiAgICAgICAgICAgIGxlYWQgPSB0aGlzW2ldO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBsZWFkO1xufTtcbiIsInZhciBNYWluTWVudSA9IGZ1bmN0aW9uKCl7fTtcbm1vZHVsZS5leHBvcnRzID0gTWFpbk1lbnU7XG5cbk1haW5NZW51LnByb3RvdHlwZSA9IHtcbiAgICBwcmVsb2FkOiBmdW5jdGlvbigpIHtcbiAgICAgICAgLy9zaG93IGxvYWRpbmcgc2NyZWVuXG4gICAgfSxcbiAgICBjcmVhdGU6IGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgeFBvc2l0aW9uID0gMzQwO1xuICAgICAgICB2YXIgeVBvc2l0aW9uID0gNjA7XG5cbiAgICAgICAgdGhpcy5wbGF5VGV4dCA9IHRoaXMuZ2FtZS5hZGQudGV4dCh4UG9zaXRpb24sIHlQb3NpdGlvbiwgJ1BsYXknLCB7IGZvbnRTaXplOiAnMzJweCcsIGZpbGw6ICcjMDAwJyB9KTtcbiAgICAgICAgdGhpcy5pbnN0cnVjdGlvbnNUZXh0ID0gdGhpcy5nYW1lLmFkZC50ZXh0KHhQb3NpdGlvbiwgeVBvc2l0aW9uICsgNjAsICdJbnN0cnVjdGlvbnMnLCB7IGZvbnRTaXplOiAnMzJweCcsIGZpbGw6ICcjMDAwJyB9KTtcbiAgICAgICAgdGhpcy5wYW5kYVRleHQgPSB0aGlzLmdhbWUuYWRkLnRleHQoeFBvc2l0aW9uLCB5UG9zaXRpb24gKyAxMjAsICdIdWcgYSBQYW5kYScsIHsgZm9udFNpemU6ICczMnB4JywgZmlsbDogJyMwMDAnIH0pO1xuICAgIH0sXG4gICAgdXBkYXRlOiBmdW5jdGlvbiAoKSB7XG5cbiAgICB9XG59OyIsIi8vbG9hZGluZyB0aGUgZ2FtZSBhc3NldHNcbnZhciBQcmVsb2FkID0gZnVuY3Rpb24oKXt9O1xubW9kdWxlLmV4cG9ydHMgPSBQcmVsb2FkO1xuXG5QcmVsb2FkLnByb3RvdHlwZSA9IHtcbiAgICBwcmVsb2FkOiBmdW5jdGlvbigpIHtcbiAgICAgICAgLy9zaG93IGxvYWRpbmcgc2NyZWVuXG4gICAgICAgIHRoaXMucHJlbG9hZEJhciA9IHRoaXMuYWRkLnNwcml0ZSh0aGlzLmdhbWUud29ybGQuY2VudGVyWCwgdGhpcy5nYW1lLndvcmxkLmNlbnRlclksICdwcmVsb2FkYmFyJyk7XG4gICAgICAgIHRoaXMucHJlbG9hZEJhci5hbmNob3Iuc2V0VG8oMC41KTtcbiAgICAgICAgdGhpcy5wcmVsb2FkQmFyLnNjYWxlLnNldFRvKDMpO1xuXG4gICAgICAgIHRoaXMubG9hZC5zZXRQcmVsb2FkU3ByaXRlKHRoaXMucHJlbG9hZEJhcik7XG5cbiAgICAgICAgdmFyIGxldmVsSnNvbiA9IEpTT04uc3RyaW5naWZ5KHJlcXVpcmUoJy4uL2pzb25nZW5lcmF0b3InKS5yZWNyZWF0ZUluaXRpYWxKc29uKCkpO1xuXG4gICAgICAgIHRoaXMubG9hZC50aWxlbWFwKCdsZXZlbDEnLCBudWxsLCBsZXZlbEpzb24sIFBoYXNlci5UaWxlbWFwLlRJTEVEX0pTT04pO1xuICAgICAgICB0aGlzLmxvYWQuaW1hZ2UoJ2dhbWVUaWxlcycsICdhc3NldHMvaW1hZ2VzL2JhY2tncm91bmRfc3ByaXRlc2hlZXQucG5nJyk7XG4gICAgICAgIHRoaXMubG9hZC5pbWFnZSgncGxheWVyJywgJ2Fzc2V0cy9pbWFnZXMvcGxheWVyLnBuZycpO1xuICAgICAgICB0aGlzLmxvYWQuaW1hZ2UoJ3BsYXllckR1Y2snLCAnYXNzZXRzL2ltYWdlcy9wbGF5ZXJfZHVjay5wbmcnKTtcbiAgICAgICAgdGhpcy5sb2FkLmltYWdlKCdwbGF5ZXJEZWFkJywgJ2Fzc2V0cy9pbWFnZXMvcGxheWVyX2RlYWQucG5nJyk7XG5cbiAgICB9LFxuICAgIGNyZWF0ZTogZnVuY3Rpb24oKSB7XG4gICAgICAgIHRoaXMuc3RhdGUuc3RhcnQoJ0dhbWUnKTtcbiAgICB9XG59OyIsInZhciB1dGlscyA9IGZ1bmN0aW9uICgpIHtcbn07XG5tb2R1bGUuZXhwb3J0cyA9IHV0aWxzO1xuXG51dGlscy5wcm90b3R5cGUgPSB7XG4gICAgZ2V0UmFuZG9tSW50OiBmdW5jdGlvbiAobWluLCBtYXgpIHtcbiAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIChtYXggLSBtaW4gKyAxKSkgKyBtaW47XG4gICAgfSxcblxuICAgIGdldF90eXBlOiBmdW5jdGlvbiAodGhpbmcpIHtcbiAgICAgICAgaWYgKHRoaW5nID09PSBudWxsKXJldHVybiBcIltvYmplY3QgTnVsbF1cIjsgLy8gc3BlY2lhbCBjYXNlXG4gICAgICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodGhpbmcpO1xuICAgIH1cbn07Il19
